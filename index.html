<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>Site Eval Dashboard (PoC)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;}
    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:24px;}
    .card{padding:16px;border:1px solid #ddd;border-radius:12px;}
    h2{margin:.2em 0}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace}
    .muted{color:#666;font-size:.9em}
  </style>
</head>
<body>
  <div id="header" class="card"></div>
<script>
function renderHeader(data){
  const st = data.site_type || {};
  const conf = st.confidence || {}; // {W_C:0.78 ...} を出せるなら（なければ省略）
  document.getElementById('header').innerHTML = `
    <h2>Site Type Code: <span class="code">${st.code || '-'}</span></h2>
    <div>W/C=${st?.W_C?.pole||'-'} (${(conf.W_C??'-')}) /
         B/S=${st?.B_S?.pole||'-'} (${(conf.B_S??'-')}) /
         F/L=${st?.F_L?.pole||'-'} (${(conf.F_L??'-')}) /
         H/T=${st?.H_T?.pole||'-'} (${(conf.H_T??'-')})</div>
  `;
}
</script>
  <h1>Site Eval Dashboard (PoC)</h1>
  <form id="runForm" class="card" style="margin:16px 0;">
  <label>評価URL: <input name="url" required style="width:60%"></label>
  <select name="engine">
    <option value="claude">claude</option>
    <option value="codex">codex</option>
  </select>
  <button type="submit">評価ジョブを作成</button>
  <span id="runMsg"></span>
</form>
<script>
const JOB_API = 'https://script.google.com/macros/s/AKfycbyiSIJfFEmrbumIe1HX6z5W_wZtPBuEoNPAkk-8jjdvAspVUpq0Irc1QLRq1w-F0yaIHg/exec'; // doPost対応
const TOKEN = '<<任意: ScriptPropertiesのAPI_TOKEN>>';
document.getElementById('runForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {
    action: 'enqueue',
    url: fd.get('url'),
    engine: fd.get('engine') || 'claude',
    themes: 'ALL',
    allowed_items: 'ALL',
    token: TOKEN
  };
  const r = await fetch(JOB_API, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  const j = await r.json();
  console.log('jobAPI response:', j);
  document.getElementById('runMsg').textContent =
    j.ok ? `ジョブ登録: ${j.job_id}` : `エラー: ${j.error||'unknown'}`;
});
</script>
  <div id="meta" class="card">Loading…</div>
  <div class="wrap">
    <div class="card"><h2>Tier1（三角値）</h2><div id="t1"></div></div>
    <div class="card"><h2>Tier2（レーダー）</h2><canvas id="radar" height="280"></canvas></div>
  </div>

<script>
(async function () {
  /** =============================
   *  CONFIG
   *  ============================= */
  // ★Apps Script doGet（Code.gs側）WebAppのベースURL（末尾は /exec で終わること）
  const BASE_API = 'https://script.google.com/macros/s/AKfycbyo8iTPtCLE2T20QayS5Ja_wOCxlhlkj5qGQnUKvvF7TVJvhjfXqFePUvoFftgjulqaPA/exec';
  const DEFAULT_QUERY = 'latest=1'; // ?latest=1 を既定に

  /** =============================
   *  Build API URL from querystring
   *  ============================= */
  function buildApiUrl(base, defaultQuery) {
    const qsIn = new URLSearchParams(location.search);
    const qsOut = new URLSearchParams();

    // 透過パラメタ：run_id / engine / token
    ['run_id', 'engine', 'token', 'latest'].forEach(k => {
      const v = qsIn.get(k);
      if (v != null && v !== '') qsOut.set(k, v);
    });

    // 何も指定がなければ latest=1 を追加
    if (![...qsOut.keys()].length) {
      defaultQuery.split('&').forEach(pair => {
        const [k, v] = pair.split('=');
        if (k) qsOut.set(k, v ?? '');
      });
    }

    const s = qsOut.toString();
    return s ? `${base}?${s}` : base;
  }

  const API = buildApiUrl(BASE_API, DEFAULT_QUERY);

  /** =============================
   *  Fetch & Normalize
   *  ============================= */
  let payload;
  try {
    const resp = await fetch(API, { method: 'GET' });
    payload = await resp.json();
  } catch (e) {
    showError(`API fetch failed: ${String(e)}`);
    return;
  }
  if (!payload || payload.ok === false) {
    showError(`API error: ${payload && (payload.error || 'unknown')}`);
    return;
  }

  const raw = payload.data;
  // フラット(scores_flat) or ネスト(scores) をユニファイ
  const model = Array.isArray(raw) ? fromFlat(raw) : fromNested(raw);

  /** =============================
   *  Render Header (Site Type)
   *  ============================= */
  try {
    renderHeader({ site_type: model.site_type });
  } catch (e) {
    // headerは必須ではないので握りつぶし
  }

  /** =============================
   *  Render (Meta)
   *  ============================= */
  const metaEl = document.getElementById('meta');
  metaEl.innerHTML = `
    <h2>対象</h2>
    <div>URL: <a href="${escapeHtml(model.target_url||'-')}" target="_blank" rel="noreferrer">${escapeHtml(model.target_url||'-')}</a></div>
    <div>Run: <span class="code">${escapeHtml(model.run_id||'-')}</span> / Engine: ${escapeHtml(model.engine_label||'-')}</div>
    <div>SiteType: <span class="code">${escapeHtml(model.site_type?.code||'-')}</span>
      （W/C=${escapeHtml(model.site_type?.W_C?.pole||'-')} /
         B/S=${escapeHtml(model.site_type?.B_S?.pole||'-')} /
         F/L=${escapeHtml(model.site_type?.F_L?.pole||'-')} /
         H/T=${escapeHtml(model.site_type?.H_T?.pole||'-')}）</div>
    <div>Evaluated: ${escapeHtml(model.evaluated_at||'-')}</div>
    ${payload.source ? `<div class="muted">source: ${escapeHtml(payload.source.file_name||'')} / ${escapeHtml(payload.source.last_updated_iso||'')}</div>` : '' }
  `;

  /** =============================
   *  Render (Tier1)
   *  ============================= */
  const t1Div = document.getElementById('t1');
  if ((model.tier1||[]).length) {
    const line = model.tier1.map(x => `${escapeHtml(x.name)}: <b>${x.normalized_100 ?? '-'}</b>`).join(' / ');
    t1Div.innerHTML = line;
  } else {
    t1Div.textContent = '—';
  }

  /** =============================
   *  Render (Tier2 → Radar / Bar fallback)
   *  ============================= */
  const t2 = (model.tier2 || []).filter(x => typeof x.normalized_100 === 'number');
  const ctx = document.getElementById('radar').getContext('2d');

  if (t2.length >= 3) {
    new Chart(ctx, {
      type:'radar',
      data:{
        labels: t2.map(d=>d.name),
        datasets:[{ label:'Tier2', data: t2.map(d=>d.normalized_100), fill:true }]
      },
      options:{
        responsive:true,
        scales:{ r:{ suggestedMin:0, suggestedMax:100, ticks:{ stepSize:20 } } },
        plugins:{ legend:{ display:false } }
      }
    });
  } else if (t2.length > 0) {
    new Chart(ctx, {
      type:'bar',
      data:{
        labels: t2.map(d=>d.name),
        datasets:[{ label:'Tier2', data: t2.map(d=>d.normalized_100) }]
      },
      options:{
        indexAxis:'y',
        responsive:true,
        scales:{ x:{ min:0, max:100, ticks:{ stepSize:20 } } },
        plugins:{ legend:{ display:false } }
      }
    });
  } else {
    ctx.canvas.parentElement.innerHTML = '<div>Tier2データがありません</div>';
  }

  /** =============================
   *  Helpers
   *  ============================= */
  function fromFlat(rows) {
    // 代表メタ
    const meta = rows[0] || {};
    const run_id = meta.run_id || null;
    const engine_label = meta.engine_label || null;
    const target_url = meta.target_url || null;

    // Tier1
    const t1 = rows
      .filter(r => r.tier === 'tier1' && r.metric === 'normalized_100')
      .map(r => ({ name: r.name, normalized_100: r.value }));

    // Tier2
    const t2 = rows
      .filter(r => r.tier === 'tier2' && r.metric === 'normalized_100')
      .map(r => ({ name: r.name, normalized_100: r.value }));

    // SiteType
    const code = pickFlat(rows, 'site_type', 'code', 'code');
    const wc   = pickFlat(rows, 'site_type', 'W_C', 'pole');
    const bs   = pickFlat(rows, 'site_type', 'B_S', 'pole');
    const fl   = pickFlat(rows, 'site_type', 'F_L', 'pole');
    const ht   = pickFlat(rows, 'site_type', 'H_T', 'pole');

    return {
      run_id, engine_label, target_url,
      evaluated_at: null, // flatには無い想定
      tier1: t1, tier2: t2,
      site_type: {
        code,
        W_C: wc ? { pole: wc } : null,
        B_S: bs ? { pole: bs } : null,
        F_L: fl ? { pole: fl } : null,
        H_T: ht ? { pole: ht } : null
      }
    };
  }

  function pickFlat(rows, tier, name, metric) {
    const hit = rows.find(r => r.tier === tier && r.name === name && r.metric === metric);
    return hit ? hit.value : null;
  }

  function fromNested(obj) {
    // tier1_scores が {Warmth:30,...} なら配列化
    let t1 = [];
    if (Array.isArray(obj.tier1)) {
      t1 = obj.tier1.map(x => ({ name: x.name, normalized_100: x.normalized_100 ?? x.normalized }));
    } else if (obj.tier1_scores && typeof obj.tier1_scores === 'object') {
      t1 = Object.entries(obj.tier1_scores).map(([k, v]) => ({ name: k, normalized_100: v }));
    }

    // tier2_scores 配列 → normalized_100を拾う
    const t2src = obj.tier2 || obj.tier2_scores || [];
    const t2 = (Array.isArray(t2src) ? t2src : []).map(x => ({
      name: x.name, normalized_100: x.normalized_100 ?? x.normalized
    }));

    return {
      run_id: obj.metadata?.run_id || obj.run?.run_id || null,
      engine_label: obj.metadata?.engine_label || obj.run?.engine_label || null,
      target_url: obj.metadata?.target_url || obj.run?.target_url || null,
      evaluated_at: obj.metadata?.evaluated_at || null,
      tier1: t1,
      tier2: t2,
      site_type: obj.site_type || null
    };
  }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&lt;&gt;&amp;&quot;']/g, m => (
      {'&amp;':'&amp;','&lt;':'&lt;','&gt;':'&gt;','&quot;':'&quot;','&#39;':'&#39;'}[m] || m
    ));
  }

  function showError(msg){
    const meta = document.getElementById('meta');
    meta.innerHTML = `<div style="color:#b00">Error: ${escapeHtml(msg)}</div>
      <div class="muted">API: ${escapeHtml(API)}</div>`;
  }
})();
</script>
</body>
</html>
