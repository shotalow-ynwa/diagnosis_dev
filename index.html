<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>Site Eval Dashboard (PoC)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;}
    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:24px;}
    .card{padding:16px;border:1px solid #ddd;border-radius:12px;}
    h2{margin:.2em 0}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace}
    .muted{color:#666;font-size:.9em}
    .toast{position:fixed;top:20px;right:20px;padding:12px 20px;background:#4caf50;color:white;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:1000;animation:slideIn 0.3s;}
    .toast.error{background:#f44336}
    .toast.info{background:#2196f3}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .polling{display:inline-block;margin-left:8px;color:#666;font-size:.9em}
    .polling::after{content:'●';animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
    #historySelect{margin:8px 0;padding:4px 8px;font-size:.9em}
    .top-drivers{list-style:none;padding:0;margin:8px 0}
    .top-drivers li{padding:4px 0;border-bottom:1px solid #eee}
    .top-drivers li:last-child{border-bottom:none}
  </style>
</head>
<body>
  <div id="header" class="card"></div>
<script>
function renderHeader(data){
  const st = data.site_type || {};
  const conf = st.confidence || {}; // {W_C:0.78 ...} を出せるなら（なければ省略）
  const pct = v => (typeof v === 'number' ? Math.round(v*100) + '%' : '-');
  document.getElementById('header').innerHTML = `
    <h2>Site Type Code: <span class="code">${st.code || '-'}</span></h2>
    <div>W/C=${st?.W_C?.pole||'-'} (${pct(conf.W_C)}) /
         B/S=${st?.B_S?.pole||'-'} (${pct(conf.B_S)}) /
         F/L=${st?.F_L?.pole||'-'} (${pct(conf.F_L)}) /
         H/T=${st?.H_T?.pole||'-'} (${pct(conf.H_T)})</div>
  `;
}
</script>
  <h1>Site Eval Dashboard (PoC)</h1>
  <form id="runForm" class="card" style="margin:16px 0;">
  <label>評価URL: <input name="url" required style="width:60%"></label>
  <select name="engine">
    <option value="claude">claude</option>
    <option value="codex">codex</option>
  </select>
  <button type="submit">評価ジョブを作成</button>
  <span id="runMsg"></span>
</form>
<div class="card" style="margin:16px 0;">
  <label>履歴: <select id="historySelect"><option value="">最新を表示</option></select></label>
</div>
<script>
const JOB_API = 'https://script.google.com/macros/s/AKfycbyiSIJfFEmrbumIe1HX6z5W_wZtPBuEoNPAkk-8jjdvAspVUpq0Irc1QLRq1w-F0yaIHg/exec'; // doPost対応
const TOKEN = '<<任意: ScriptPropertiesのAPI_TOKEN>>';
let pollingInterval = null;
let currentRunId = null;

// トースト表示
function showToast(message, type='success'){
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(()=>{
    toast.style.animation = 'slideIn 0.3s reverse';
    setTimeout(()=>toast.remove(), 300);
  }, 3000);
}

// ポーリング開始
function startPolling(runId){
  if (pollingInterval) clearInterval(pollingInterval);
  currentRunId = runId;
  const pollMsg = document.getElementById('runMsg');
  pollMsg.innerHTML = `ジョブ登録完了。結果を待機中... <span class="polling"></span>`;
  
  let pollCount = 0;
  const MAX_POLLS = 18; // 90秒（5秒×18回）
  
  pollingInterval = setInterval(async ()=>{
    pollCount++;
    
    // タイムアウトチェック
    if (pollCount >= MAX_POLLS){
      clearInterval(pollingInterval);
      pollMsg.innerHTML = '結果が遅延しています。<a href="?latest=1" style="color:#2196f3;text-decoration:underline">履歴から再表示してください</a>';
      showToast('ポーリングがタイムアウトしました。履歴から確認してください。', 'info');
      return;
    }
    
    try{
      const API = buildApiUrl(BASE_API, '');
      const url = `${API}&run_id=${encodeURIComponent(runId)}`;
      const resp = await fetch(url);
      const payload = await resp.json();
      
      if (payload.ok && payload.data && payload.data.length > 0){
        // Tier1データが存在するかチェック
        const hasTier1 = payload.data.some(r => r.tier === 'tier1' && r.value != null);
        if (hasTier1){
          clearInterval(pollingInterval);
          pollMsg.textContent = '評価完了！';
          showToast('評価が完了しました', 'success');
          // ページを再読み込み（run_id付き）
          window.location.href = `?run_id=${encodeURIComponent(runId)}`;
        }
      }
    }catch(e){
      console.error('Polling error:', e);
    }
  }, 5000);
}

// フォーム送信
document.getElementById('runForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {
    action: 'enqueue',
    url: fd.get('url'),
    engine: fd.get('engine') || 'claude',
    themes: 'ALL',
    allowed_items: 'ALL',
    token: TOKEN
  };
  
  const btn = e.target.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.textContent = '登録中...';
  
  try{
    const r = await fetch(JOB_API, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    console.log('jobAPI response:', j);
    
    if (j.ok && j.job_id){
      showToast(`ジョブ登録完了: ${j.job_id}`, 'success');
      // ポーリング開始（run_idは後でRunner側から取得される想定）
      // 暫定：URLから推測できるrun_idを生成（実際はRunner側でjob_id→run_idマッピングが必要）
      const runId = `run_${new Date().toISOString().replace(/[:.TZ-]/g,'')}`;
      startPolling(runId);
      // クエリにjob_idを付与（将来のrun_idマッピング用）
      const url = new URL(window.location);
      url.searchParams.set('job_id', j.job_id);
      window.history.pushState({}, '', url);
    } else {
      showToast(`エラー: ${j.error||'unknown'}`, 'error');
      btn.disabled = false;
      btn.textContent = '評価ジョブを作成';
    }
  }catch(err){
    showToast(`エラー: ${String(err)}`, 'error');
    btn.disabled = false;
    btn.textContent = '評価ジョブを作成';
  }
});

// 履歴セレクタ
async function loadHistory(){
  const select = document.getElementById('historySelect');
  select.innerHTML = '<option value="">読み込み中…</option>';
  
  try{
    const API = buildApiUrl(BASE_API, '');
    const url = `${API}&list=1&limit=20`;
    const resp = await fetch(url);
    const payload = await resp.json();
    
    if (payload.ok && payload.data){
      select.innerHTML = '<option value="">最新を表示</option>';
      payload.data.forEach(item=>{
        const opt = document.createElement('option');
        opt.value = item.run_id;
        opt.textContent = `${item.run_id} (${item.engine_label}) - ${item.site_type_code || '-'} - ${item.evaluated_at ? new Date(item.evaluated_at).toLocaleString('ja-JP') : ''}`;
        select.appendChild(opt);
      });
      
      // 現在のrun_idと一致するものを選択
      const qs = new URLSearchParams(location.search);
      const currentRunId = qs.get('run_id');
      if (currentRunId){
        select.value = currentRunId;
      }
    } else {
      select.innerHTML = '<option value="">取得失敗</option>';
    }
  }catch(e){
    console.error('History load error:', e);
    select.innerHTML = '<option value="">取得失敗</option>';
  }
}

document.getElementById('historySelect').addEventListener('change', (e)=>{
  const runId = e.target.value;
  if (runId){
    window.location.href = `?run_id=${encodeURIComponent(runId)}`;
  } else {
    window.location.href = '?latest=1';
  }
});

// ページ読み込み時に履歴を読み込む
loadHistory();
</script>
  <div id="meta" class="card">Loading…</div>
  <div class="wrap">
    <div class="card"><h2>Tier1（三角値）</h2><div id="t1"></div></div>
    <div class="card">
      <h2>Tier2（レーダー）</h2>
      <canvas id="radar" height="280"></canvas>
      <div style="margin-top:16px;">
        <h3 style="font-size:1em;margin:.5em 0">Top Drivers</h3>
        <ul id="topDrivers" class="top-drivers"></ul>
      </div>
    </div>
  </div>

<script>
// BASE_APIをグローバルに（ポーリング用）
const BASE_API = 'https://script.google.com/macros/s/AKfycbyo8iTPtCLE2T20QayS5Ja_wOCxlhlkj5qGQnUKvvF7TVJvhjfXqFePUvoFftgjulqaPA/exec';
const DEFAULT_QUERY = 'latest=1'; // ?latest=1 を既定に

/** =============================
 *  Build API URL from querystring
 *  ============================= */
function buildApiUrl(base, defaultQuery) {
  const qsIn = new URLSearchParams(location.search);
  const qsOut = new URLSearchParams();

  // 透過パラメタ：run_id / engine / token / latest / list
  ['run_id', 'engine', 'token', 'latest', 'list', 'limit'].forEach(k => {
    const v = qsIn.get(k);
    if (v != null && v !== '') qsOut.set(k, v);
  });

  // 何も指定がなければ latest=1 を追加
  if (![...qsOut.keys()].length) {
    defaultQuery.split('&').forEach(pair => {
      const [k, v] = pair.split('=');
      if (k) qsOut.set(k, v ?? '');
    });
  }

  const s = qsOut.toString();
  return s ? `${base}?${s}` : base;
}

(async function () {
  /** =============================
   *  CONFIG
   *  ============================= */
  const API = buildApiUrl(BASE_API, DEFAULT_QUERY);

  /** =============================
   *  Fetch & Normalize
   *  ============================= */
  let payload;
  try {
    const resp = await fetch(API, { method: 'GET' });
    payload = await resp.json();
  } catch (e) {
    showError(`API fetch failed: ${String(e)}`);
    return;
  }
  if (!payload || payload.ok === false) {
    showError(`API error: ${payload && (payload.error || 'unknown')}`);
    return;
  }

  const raw = payload.data;
  // フラット(scores_flat) or ネスト(scores) をユニファイ
  const model = Array.isArray(raw) ? fromFlat(raw) : fromNested(raw);

  /** =============================
   *  Render Header (Site Type)
   *  ============================= */
  try {
    renderHeader({ site_type: model.site_type });
  } catch (e) {
    // headerは必須ではないので握りつぶし
  }

  /** =============================
   *  Render (Meta)
   *  ============================= */
  const metaEl = document.getElementById('meta');
  metaEl.innerHTML = `
    <h2>対象</h2>
    <div>URL: <a href="${escapeHtml(model.target_url||'-')}" target="_blank" rel="noreferrer">${escapeHtml(model.target_url||'-')}</a></div>
    <div>Run: <span class="code">${escapeHtml(model.run_id||'-')}</span> / Engine: ${escapeHtml(model.engine_label||'-')}</div>
    <div>SiteType: <span class="code">${escapeHtml(model.site_type?.code||'-')}</span>
      （W/C=${escapeHtml(model.site_type?.W_C?.pole||'-')} /
         B/S=${escapeHtml(model.site_type?.B_S?.pole||'-')} /
         F/L=${escapeHtml(model.site_type?.F_L?.pole||'-')} /
         H/T=${escapeHtml(model.site_type?.H_T?.pole||'-')}）</div>
    <div>Evaluated: ${escapeHtml(model.evaluated_at||'-')}</div>
    ${payload.source ? `<div class="muted">source: ${escapeHtml(payload.source.file_name||'')} / ${escapeHtml(payload.source.last_updated_iso||'')}</div>` : '' }
  `;

  /** =============================
   *  Render (Tier1)
   *  ============================= */
  const t1Div = document.getElementById('t1');
  if ((model.tier1||[]).length) {
    const line = model.tier1.map(x => `${escapeHtml(x.name)}: <b>${x.normalized_100 ?? '-'}</b>`).join(' / ');
    t1Div.innerHTML = line;
  } else {
    t1Div.textContent = '—';
  }

  /** =============================
   *  Render (Tier2 → Radar / Bar fallback)
   *  ============================= */
  const t2 = (model.tier2 || []).filter(x => typeof x.normalized_100 === 'number');
  const ctx = document.getElementById('radar').getContext('2d');

  if (t2.length >= 3) {
    new Chart(ctx, {
      type:'radar',
      data:{
        labels: t2.map(d=>d.name),
        datasets:[{ label:'Tier2', data: t2.map(d=>d.normalized_100), fill:true }]
      },
      options:{
        responsive:true,
        scales:{ r:{ suggestedMin:0, suggestedMax:100, ticks:{ stepSize:20 } } },
        plugins:{ legend:{ display:false } }
      }
    });
  } else if (t2.length > 0) {
    new Chart(ctx, {
      type:'bar',
      data:{
        labels: t2.map(d=>d.name),
        datasets:[{ label:'Tier2', data: t2.map(d=>d.normalized_100) }]
      },
      options:{
        indexAxis:'y',
        responsive:true,
        scales:{ x:{ min:0, max:100, ticks:{ stepSize:20 } } },
        plugins:{ legend:{ display:false } }
      }
    });
  } else {
    ctx.canvas.parentElement.innerHTML = '<div>Tier2データがありません</div>';
  }

  /** =============================
   *  Render (Top Drivers)
   *  ============================= */
  const topDriversEl = document.getElementById('topDrivers');
  if (t2.length > 0){
    const sorted = [...t2].sort((a,b) => (b.normalized_100 || 0) - (a.normalized_100 || 0));
    const top3 = sorted.slice(0, 3);
    topDriversEl.innerHTML = top3.map(d => {
      const val = Number.isFinite(d.normalized_100) ? d.normalized_100.toFixed(1) : '-';
      return `<li><strong>${escapeHtml(d.name)}</strong>: ${val}</li>`;
    }).join('');
  } else {
    topDriversEl.innerHTML = '<li>データがありません</li>';
  }

  /** =============================
   *  Helpers
   *  ============================= */
  function fromFlat(rows) {
    // 代表メタ
    const meta = rows[0] || {};
    const run_id = meta.run_id || null;
    const engine_label = meta.engine_label || null;
    const target_url = meta.target_url || null;

    // Tier1
    const t1 = rows
      .filter(r => r.tier === 'tier1' && r.metric === 'normalized_100')
      .map(r => ({ name: r.name, normalized_100: r.value }));

    // Tier2
    const t2 = rows
      .filter(r => r.tier === 'tier2' && r.metric === 'normalized_100')
      .map(r => ({ name: r.name, normalized_100: r.value }));

    // SiteType
    const code = pickFlat(rows, 'site_type', 'code', 'code');
    const wc   = pickFlat(rows, 'site_type', 'W_C', 'pole');
    const bs   = pickFlat(rows, 'site_type', 'B_S', 'pole');
    const fl   = pickFlat(rows, 'site_type', 'F_L', 'pole');
    const ht   = pickFlat(rows, 'site_type', 'H_T', 'pole');

    return {
      run_id, engine_label, target_url,
      evaluated_at: null, // flatには無い想定
      tier1: t1, tier2: t2,
      site_type: {
        code,
        W_C: wc ? { pole: wc } : null,
        B_S: bs ? { pole: bs } : null,
        F_L: fl ? { pole: fl } : null,
        H_T: ht ? { pole: ht } : null
      }
    };
  }

  function pickFlat(rows, tier, name, metric) {
    const hit = rows.find(r => r.tier === tier && r.name === name && r.metric === metric);
    return hit ? hit.value : null;
  }

  function fromNested(obj) {
    // tier1_scores が {Warmth:30,...} なら配列化
    let t1 = [];
    if (Array.isArray(obj.tier1)) {
      t1 = obj.tier1.map(x => ({ name: x.name, normalized_100: x.normalized_100 ?? x.normalized }));
    } else if (obj.tier1_scores && typeof obj.tier1_scores === 'object') {
      t1 = Object.entries(obj.tier1_scores).map(([k, v]) => ({ name: k, normalized_100: v }));
    }

    // tier2_scores 配列 → normalized_100を拾う
    const t2src = obj.tier2 || obj.tier2_scores || [];
    const t2 = (Array.isArray(t2src) ? t2src : []).map(x => ({
      name: x.name, normalized_100: x.normalized_100 ?? x.normalized
    }));

    return {
      run_id: obj.metadata?.run_id || obj.run?.run_id || null,
      engine_label: obj.metadata?.engine_label || obj.run?.engine_label || null,
      target_url: obj.metadata?.target_url || obj.run?.target_url || null,
      evaluated_at: obj.metadata?.evaluated_at || null,
      tier1: t1,
      tier2: t2,
      site_type: obj.site_type || null
    };
  }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&lt;&gt;&amp;&quot;']/g, m => (
      {'&amp;':'&amp;','&lt;':'&lt;','&gt;':'&gt;','&quot;':'&quot;','&#39;':'&#39;'}[m] || m
    ));
  }

  function showError(msg){
    const meta = document.getElementById('meta');
    meta.innerHTML = `<div style="color:#b00">Error: ${escapeHtml(msg)}</div>
      <div class="muted">API: ${escapeHtml(API)}</div>`;
  }
})();
</script>
</body>
</html>
